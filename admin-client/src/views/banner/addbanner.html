<div class="layui-card layadmin-header">
	<div class="layui-breadcrumb" lay-filter="breadcrumb">
		<a lay-href="/banner/banner">轮播图</a>
		<a>
			<cite>新增轮播图</cite>
		</a>
	</div>
</div>
<div class="shop-manage-content" style="padding: 10px;">

	<div class="content-body" style="padding: 10px;background: #fff">

		<form class="layui-form layui-form-pane1" action="">

			<div class="layui-form-item ">
				<label class="layui-form-label">
                    <span class="star">*</span>名称:</label>
				<div class="layui-input-inline">
					<input id="name" type="text" name="name" lay-verify="required|name" required placeholder="输入轮播标题" autocomplete="off" class="layui-input jing">
				</div>
			</div>
			<div class="layui-form-item ">
				<label class="layui-form-label">
                    <span class="star">*</span>显示顺序:</label>
				<div class="layui-input-inline">
					<input id="sort" type="number" name="sort" lay-verify="required|name" required placeholder="数字越小越靠前" autocomplete="off" class="layui-input jing">
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">
                    <span class="star">*</span>商品链接:</label>
				<div class="layui-input-inline">
					<select id="products">
						<option selected value="1">不跳转</option>
					</select>
				</div>
			</div>
			<!--上传图片-->
			<div class="form-input clearl">
				<label class="layui-form-label">
                    <span class="star">*</span>活动图片:<br>宽高比:</br>750*366</label>
				<div class="fileView">

					<div class="btn_file">
						<img src="" id="add" width="200">
						<input name="imgSrc" id="imgSrc" class="filepath" accept="image/*" onchange="previewImg(this)" type="file"><br>
					</div>
					<!--<img src="" id="show" width="200">-->
				</div>
			</div>
			<!--<div class="layui-form-item ">
                <label class="layui-form-label">
                    <span class="star">*</span>链接地址:</label>
                <div class="layui-input-inline">
                    <input id="linkUrl" type="text" style="width: 450px;" name="linkUrl" lay-verify="required|name" required placeholder="输入http://"
                        autocomplete="off" class="layui-input jing">
                </div>
            </div>-->
		</form>

		<button class="layui-btn layui-btn-normal addshopSubmit" lay-submit lay-filter="*">立即提交</button>
	</div>

</div>
<script type="text/javascript" src="crypto1/crypto/crypto.js"></script>
<script type="text/javascript" src="crypto1/hmac/hmac.js"></script>
<script type="text/javascript" src="crypto1/sha1/sha1.js"></script>
<script src="layui/plupload.full.min.js"></script>
<script src="layui/base64.js"></script>
<script src="layui/upload.js"></script>
<script type="text/javascript">
	//  upload('logo');
	layui.use(['form', 'laydate', 'layer'], function() {
		$ = layui.jquery;
		var form = layui.form;
		var laydate = layui.laydate;
		var layer = layui.layer;
		var router = layui.router()
		form.render();

		var myid = parseInt(router.search.id) //location.search.split('=')[1];

		if(myid) {
			var dataObj = {
				id: myid,
			}

			var mydata = JSON.stringify(dataObj)
			console.log(myid)
			var account = sessionStorage.getItem("account");
var token = sessionStorage.getItem("token");
			$.ajax({
				url: link + '/banner/search?id=' + myid,
				type: 'get',
				dataType: 'json',
				headers:{"account":account,"token":token},
				//              data: mydata,
				success: function(res) {
					console.log('search:', res)
					if(res.err_code == 0) {
						$('#name').val(res.data.Banner.Name);
						$('#sort').val(res.data.Banner.Index);
						$("#add").attr("src", res.data.Banner.Url);
						$("#products").val(res.data.Banner.Path);
//						var product = JSON.parse(sessionStorage.getItem("product"))
//						for(let item of product) {
//							if(item.ProductId.toString() == res.banner.Path) {
//								$("#products").append('<option value ="' + item.ProductId + '" selected>' + item.Name + '</option>')
//							} else {
//								$("#products").append('<option value ="' + item.ProductId + '">' + item.Name + '</option>')
//							}
//						}
						form.render('select');
					}

				},
				error: function(jqXHR, textStatus, errorThrown) {
					/*错误信息处理*/
					layer.close(loadicon);
					layer.msg('请求失败，原因：' + errorThrown + ',状态码：' + jqXHR.status);

				}

			});
		} else {
			$("#add").attr("src", addlink);
		}

		$(document).off("click").on("click", ".addshopSubmit", function() {
			toSubmit();
		});

		function toSubmit() {
			var name = $('#name').val();
			var sort = parseInt($('#sort').val()) 
			var img = document.getElementById('add').src;
			var band = $('#products').val()

			if(img == addlink) {
				alert('请添加图片')
				return;
			}

			var dataObj = {
				Id: myid || 0,
				Name: name,
				Index: sort,
				Url: img,
				Path: band
			}
			if(name == '') {
				alert('请填写轮播图名称')
				return;
			}
			if(sort == '') {
				alert('请输入排序')
				return;
			}
			var mydata = JSON.stringify(dataObj)
			console.log(mydata)
			var account = sessionStorage.getItem("account");
			var token = sessionStorage.getItem("token");
			var loadicon = layer.load(4); //加载动画

			$.ajax({
				url: link + '/banner/update',
				type: 'post',
				dataType: 'json',
				data: mydata,
				headers: {
					"account": account,
					"token": token
				},
				success: function(res) {
					console.log(res)
					if(res.err_code == 0) {
						location.hash = '/banner/banner'
					} else if(res.err_code == 10001) {
						layer.open({
							title: '提示信息:',
							content: res.err_msg,
							btn: ['确认'],
							yes: function(index, layero) {
								layer.close(index)
								layer.close(loadicon);
								location.hash = '/user/login';
							},
							cancel: function() {
								layer.close(loadicon);
								location.hash = '/user/login';
							}
						});
					}

				},
				error: function(jqXHR, textStatus, errorThrown) {
					/*错误信息处理*/
					layer.close(loadicon);
					layer.msg('请求失败，原因：' + errorThrown + ',状态码：' + jqXHR.status);
				}

			});

		}
	})
</script>